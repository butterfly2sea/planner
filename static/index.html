<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>稻城亚丁智能旅游规划系统</title>

  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.6.2/dist/maplibre-gl.css' />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.css">

  <script src='https://unpkg.com/maplibre-gl@5.6.2/dist/maplibre-gl.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/locale/zh-cn.js"></script>
  <script src="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --danger-color: #f56565;
      --dark-color: #2d3748;
      --gray-color: #718096;
      --light-gray: #e2e8f0;
      --bg-color: #f7fafc;
      --white: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--dark-color);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 头部样式 */
    .header {
      background: white;
      border-radius: var(--radius);
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-lg);
      text-align: center;
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 32px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .subtitle {
      color: var(--gray-color);
      font-size: 16px;
    }

    /* 主布局 */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 1fr 380px;
      gap: 20px;
      margin-top: 20px;
    }

    /* 面板样式 */
    .panel {
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .panel.collapsed {
      height: 60px;
    }

    .panel-header {
      padding: 20px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .panel-header h2 {
      font-size: 20px;
      color: var(--dark-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-actions {
      display: flex;
      gap: 8px;
    }

    .panel-toggle {
      background: none;
      border: none;
      color: var(--gray-color);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .panel-toggle:hover {
      background: var(--bg-color);
      color: var(--primary-color);
    }

    .panel-content {
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
      transition: var(--transition);
    }

    .panel.collapsed .panel-content {
      display: none;
    }

    /* 地图容器 */
    .map-container {
      height: 500px;
      position: relative;
      background: var(--bg-color);
    }

    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      gap: 8px;
    }

    /* 时间轴样式 */
    .timeline-container {
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .timeline-day {
      margin-bottom: 30px;
    }

    .timeline-date {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 15px;
      padding-left: 40px;
      position: relative;
    }

    .timeline-date::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
    }

    .timeline-item {
      display: flex;
      gap: 15px;
      padding: 15px;
      background: var(--bg-color);
      border-radius: 8px;
      margin-bottom: 10px;
      margin-left: 40px;
      position: relative;
      cursor: pointer;
      transition: var(--transition);
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -30px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: var(--gray-color);
      border-radius: 50%;
    }

    .timeline-item:hover {
      background: white;
      box-shadow: var(--shadow);
      transform: translateX(5px);
    }

    /* 甘特图容器 */
    .gantt-container {
      height: 450px;
      overflow: auto;
      padding: 20px;
    }

    /* 元素列表 */
    .items-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .item-card {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .item-card:hover {
      background: white;
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* 按钮样式 */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-color);
      color: var(--dark-color);
      border: 2px solid var(--light-gray);
    }

    .btn-secondary:hover {
      background: white;
      border-color: var(--primary-color);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* 模态框 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--light-gray);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* 表单样式 */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark-color);
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--light-gray);
      border-radius: 6px;
      font-size: 14px;
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    /* 海拔图表容器 */
    .elevation-chart-container {
      padding: 15px;
      background: var(--bg-color);
      border-radius: 8px;
      margin-top: 15px;
    }

    .elevation-chart-canvas {
      max-height: 200px;
    }

    /* GeoJSON上传区域 */
    .geojson-upload {
      border: 2px dashed var(--light-gray);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 10px;
    }

    .geojson-upload:hover {
      border-color: var(--primary-color);
      background: var(--bg-color);
    }

    .geojson-upload.dragover {
      border-color: var(--success-color);
      background: rgba(72, 187, 120, 0.1);
    }

    /* 位置选择器 */
    .location-picker {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .location-input {
      flex: 1;
    }

    .location-pick-btn {
      padding: 8px 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
    }

    .location-pick-btn:hover {
      background: var(--secondary-color);
    }

    .location-pick-btn.active {
      background: var(--success-color);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
      100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
    }

    /* 提示消息 */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: var(--dark-color);
      color: white;
      border-radius: 6px;
      box-shadow: var(--shadow-lg);
      z-index: 3000;
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from { transform: translate(-50%, 100px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    .toast.success { background: var(--success-color); }
    .toast.warning { background: var(--warning-color); }
    .toast.error { background: var(--danger-color); }

    /* 响应式设计 */
    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr 1fr;
      }

      .right-panel {
        grid-column: span 2;
      }
    }

    @media (max-width: 768px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- 头部 -->
  <div class="header">
    <h1>
      <i class="fas fa-mountain"></i>
      稻城亚丁智能旅游规划系统
    </h1>
    <div class="subtitle">全方位规划您的完美旅程 - 住宿、交通、景点一站式管理</div>
  </div>

  <!-- 主布局 -->
  <div class="main-layout">
    <!-- 左侧面板 - 地图 -->
    <div class="panel" id="map-panel">
      <div class="panel-header" onclick="togglePanel('map-panel')">
        <h2>
          <i class="fas fa-map"></i>
          地图视图
        </h2>
        <div class="panel-actions">
          <button class="panel-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>
      <div class="panel-content">
        <div id="map" class="map-container"></div>
        <div class="map-controls">
          <select class="form-control" id="map-style-select" onchange="changeMapStyle(this.value)">
            <option value="streets">街道地图</option>
            <option value="satellite">卫星地图</option>
            <option value="terrain">地形图</option>
            <option value="dark">深色地图</option>
          </select>
          <button class="btn btn-sm btn-primary" onclick="fitMapBounds()">
            <i class="fas fa-compress"></i> 适应视图
          </button>
        </div>
      </div>
    </div>

    <!-- 中间面板 - 时间轴/甘特图 -->
    <div class="panel" id="timeline-panel">
      <div class="panel-header" onclick="togglePanel('timeline-panel')">
        <h2>
          <i class="fas fa-stream"></i>
          时间轴 & 甘特图
        </h2>
        <div class="panel-actions">
          <button class="btn btn-sm btn-secondary" onclick="switchView('timeline')">时间轴</button>
          <button class="btn btn-sm btn-secondary" onclick="switchView('gantt')">甘特图</button>
          <button class="panel-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>
      <div class="panel-content">
        <div id="timeline-view" class="timeline-container">
          <!-- 时间轴内容 -->
        </div>
        <div id="gantt-view" class="gantt-container" style="display: none;">
          <!-- 甘特图内容 -->
        </div>
      </div>
    </div>

    <!-- 右侧面板 - 元素列表 -->
    <div class="panel" id="items-panel">
      <div class="panel-header" onclick="togglePanel('items-panel')">
        <h2>
          <i class="fas fa-list"></i>
          旅游元素
        </h2>
        <div class="panel-actions">
          <button class="btn btn-sm btn-primary" onclick="openAddItemModal()">
            <i class="fas fa-plus"></i> 添加
          </button>
          <button class="panel-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>
      <div class="panel-content">
        <div class="items-list" id="items-list">
          <!-- 元素列表内容 -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 添加/编辑元素模态框 -->
<div class="modal" id="item-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">添加旅游元素</h3>
      <button onclick="closeModal('item-modal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <form id="item-form">
        <div class="form-row">
          <div class="form-group">
            <label>类型 *</label>
            <select class="form-control" id="item-type" required onchange="onItemTypeChange(this.value)">
              <option value="">请选择</option>
              <option value="accommodation">住宿</option>
              <option value="transport">交通</option>
              <option value="attraction">景点</option>
              <option value="photo_spot">拍照点</option>
              <option value="rest_area">休息点</option>
              <option value="other">其他</option>
            </select>
          </div>
          <div class="form-group">
            <label>名称 *</label>
            <input type="text" class="form-control" id="item-name" required>
          </div>
        </div>

        <div class="form-group">
          <label>描述</label>
          <textarea class="form-control" id="item-description" rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>开始时间 *</label>
            <input type="datetime-local" class="form-control" id="item-start-time" required>
          </div>
          <div class="form-group">
            <label>结束时间 *</label>
            <input type="datetime-local" class="form-control" id="item-end-time" required>
          </div>
        </div>

        <div class="form-group">
          <label>位置</label>
          <div class="location-picker">
            <input type="text" class="form-control location-input" id="item-location" placeholder="纬度, 经度 或 点击地图选择">
            <button type="button" class="location-pick-btn" id="location-pick-btn" onclick="toggleLocationPicker()">
              <i class="fas fa-map-marker-alt"></i> 地图选点
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>费用</label>
          <input type="number" class="form-control" id="item-cost" step="0.01" min="0">
        </div>

        <!-- 交通类型特殊字段 -->
        <div id="transport-fields" style="display: none;">
          <div class="form-group">
            <label>导入轨迹 (GeoJSON)</label>
            <div class="geojson-upload" id="geojson-upload">
              <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--gray-color); margin-bottom: 10px;"></i>
              <p>拖拽GeoJSON文件到此处或点击选择</p>
              <input type="file" id="geojson-file" accept=".json,.geojson" style="display: none;">
            </div>
          </div>
          <div id="elevation-preview" style="display: none;">
            <div class="elevation-chart-container">
              <h4>海拔剖面图</h4>
              <canvas id="elevation-chart" class="elevation-chart-canvas"></canvas>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('item-modal')">取消</button>
      <button class="btn btn-primary" onclick="saveItem()">
        <i class="fas fa-save"></i> 保存
      </button>
    </div>
  </div>
</div>

<script>
  // 配置dayjs
  dayjs.locale('zh-cn');

  // 全局变量
  let map = null;
  let markers = [];
  let tempMarker = null;
  let travelItems = [];
  let selectedItem = null;
  let editingItem = null;
  let isPickingLocation = false;
  let ganttChart = null;
  let elevationData = null;

  // 初始化
  document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadSampleData();
  });

  // 初始化地图
  function initMap() {
    const mapStyles = {
      streets: {
        version: 8,
        sources: {
          'osm': {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256
          }
        },
        layers: [{
          id: 'osm',
          type: 'raster',
          source: 'osm'
        }]
      },
      satellite: {
        version: 8,
        sources: {
          'satellite': {
            type: 'raster',
            tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
            tileSize: 256
          }
        },
        layers: [{
          id: 'satellite',
          type: 'raster',
          source: 'satellite'
        }]
      },
      terrain: {
        version: 8,
        sources: {
          'terrain': {
            type: 'raster',
            tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'],
            tileSize: 256
          }
        },
        layers: [{
          id: 'terrain',
          type: 'raster',
          source: 'terrain'
        }]
      },
      dark: {
        version: 8,
        sources: {
          'dark': {
            type: 'raster',
            tiles: ['https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}.png'],
            tileSize: 256
          }
        },
        layers: [{
          id: 'dark',
          type: 'raster',
          source: 'dark'
        }]
      }
    };

    map = new maplibregl.Map({
      container: 'map',
      style: mapStyles.streets,
      center: [100.3, 28.5],
      zoom: 11
    });

    // 添加导航控件
    map.addControl(new maplibregl.NavigationControl());

    // 地图点击事件
    map.on('click', function(e) {
      if (isPickingLocation) {
        const lat = e.lngLat.lat.toFixed(6);
        const lng = e.lngLat.lng.toFixed(6);
        document.getElementById('item-location').value = `${lat}, ${lng}`;

        // 添加临时标记
        if (tempMarker) tempMarker.remove();
        tempMarker = new maplibregl.Marker({ color: '#48bb78' })
                .setLngLat([lng, lat])
                .addTo(map);
      }
    });

    window.mapStyles = mapStyles;
  }

  // 切换地图样式
  function changeMapStyle(style) {
    if (window.mapStyles && window.mapStyles[style]) {
      map.setStyle(window.mapStyles[style]);
      // 重新添加标记
      setTimeout(() => updateMarkers(), 100);
    }
  }

  // 切换面板折叠状态
  function togglePanel(panelId) {
    const panel = document.getElementById(panelId);
    panel.classList.toggle('collapsed');

    const icon = panel.querySelector('.panel-toggle i');
    if (panel.classList.contains('collapsed')) {
      icon.className = 'fas fa-chevron-right';
    } else {
      icon.className = 'fas fa-chevron-down';
    }

    // 保存状态到localStorage
    localStorage.setItem(`panel-${panelId}`, panel.classList.contains('collapsed'));
  }

  // 恢复面板状态
  function restorePanelStates() {
    ['map-panel', 'timeline-panel', 'items-panel'].forEach(panelId => {
      const collapsed = localStorage.getItem(`panel-${panelId}`) === 'true';
      if (collapsed) {
        document.getElementById(panelId).classList.add('collapsed');
        document.querySelector(`#${panelId} .panel-toggle i`).className = 'fas fa-chevron-right';
      }
    });
  }

  // 切换视图（时间轴/甘特图）
  function switchView(view) {
    const timelineView = document.getElementById('timeline-view');
    const ganttView = document.getElementById('gantt-view');

    if (view === 'timeline') {
      timelineView.style.display = 'block';
      ganttView.style.display = 'none';
    } else {
      timelineView.style.display = 'none';
      ganttView.style.display = 'block';
      renderGantt();
    }
  }

  // 切换位置选择器
  function toggleLocationPicker() {
    isPickingLocation = !isPickingLocation;
    const btn = document.getElementById('location-pick-btn');

    if (isPickingLocation) {
      btn.classList.add('active');
      btn.innerHTML = '<i class="fas fa-times"></i> 取消选点';
      showToast('请在地图上点击选择位置', 'info');
    } else {
      btn.classList.remove('active');
      btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> 地图选点';
      if (tempMarker) {
        tempMarker.remove();
        tempMarker = null;
      }
    }
  }

  // 元素类型改变事件
  function onItemTypeChange(type) {
    const transportFields = document.getElementById('transport-fields');
    if (type === 'transport') {
      transportFields.style.display = 'block';
      initGeoJSONUpload();
    } else {
      transportFields.style.display = 'none';
    }
  }

  // 初始化GeoJSON上传
  function initGeoJSONUpload() {
    const uploadArea = document.getElementById('geojson-upload');
    const fileInput = document.getElementById('geojson-file');

    uploadArea.onclick = () => fileInput.click();

    uploadArea.ondragover = (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    };

    uploadArea.ondragleave = () => {
      uploadArea.classList.remove('dragover');
    };

    uploadArea.ondrop = (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleGeoJSONFile(e.dataTransfer.files[0]);
    };

    fileInput.onchange = (e) => {
      handleGeoJSONFile(e.target.files[0]);
    };
  }

  // 处理GeoJSON文件
  function handleGeoJSONFile(file) {
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const geojson = JSON.parse(e.target.result);
        processGeoJSON(geojson);
      } catch (error) {
        showToast('GeoJSON文件格式错误', 'error');
      }
    };
    reader.readAsText(file);
  }

  // 处理GeoJSON数据
  function processGeoJSON(geojson) {
    if (geojson.type === 'FeatureCollection' && geojson.features.length > 0) {
      const feature = geojson.features[0];
      if (feature.geometry.type === 'LineString') {
        const coordinates = feature.geometry.coordinates;

        // 提取海拔数据
        elevationData = coordinates.map((coord, index) => {
          const distance = index > 0 ? calculateDistance(coordinates.slice(0, index + 1)) : 0;
          return {
            distance: distance,
            elevation: coord[2] || 0  // 第三个值是海拔
          };
        });

        // 显示海拔图表
        showElevationChart();

        // 在地图上显示轨迹
        if (map.getSource('route')) {
          map.removeLayer('route');
          map.removeSource('route');
        }

        map.addSource('route', {
          type: 'geojson',
          data: geojson
        });

        map.addLayer({
          id: 'route',
          type: 'line',
          source: 'route',
          layout: {
            'line-join': 'round',
            'line-cap': 'round'
          },
          paint: {
            'line-color': '#3182ce',
            'line-width': 3
          }
        });

        // 适应地图边界
        const bounds = new maplibregl.LngLatBounds();
        coordinates.forEach(coord => {
          bounds.extend([coord[0], coord[1]]);
        });
        map.fitBounds(bounds, { padding: 50 });

        showToast('轨迹导入成功', 'success');
      }
    }
  }

  // 计算距离
  function calculateDistance(coordinates) {
    let distance = 0;
    for (let i = 1; i < coordinates.length; i++) {
      const lat1 = coordinates[i - 1][1] * Math.PI / 180;
      const lat2 = coordinates[i][1] * Math.PI / 180;
      const deltaLat = (coordinates[i][1] - coordinates[i - 1][1]) * Math.PI / 180;
      const deltaLng = (coordinates[i][0] - coordinates[i - 1][0]) * Math.PI / 180;

      const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const d = 6371 * c; // 地球半径（公里）

      distance += d;
    }
    return distance;
  }

  // 显示海拔图表
  function showElevationChart() {
    if (!elevationData) return;

    document.getElementById('elevation-preview').style.display = 'block';

    const ctx = document.getElementById('elevation-chart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: elevationData.map(d => `${d.distance.toFixed(1)}km`),
        datasets: [{
          label: '海拔（米）',
          data: elevationData.map(d => d.elevation),
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: '海拔（米）'
            }
          },
          x: {
            title: {
              display: true,
              text: '距离'
            }
          }
        }
      }
    });
  }

  // 打开添加元素模态框
  function openAddItemModal() {
    editingItem = null;
    document.getElementById('modal-title').textContent = '添加旅游元素';
    document.getElementById('item-form').reset();
    document.getElementById('item-modal').classList.add('active');

    // 重置位置选择器
    isPickingLocation = false;
    const btn = document.getElementById('location-pick-btn');
    btn.classList.remove('active');
    btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> 地图选点';

    if (tempMarker) {
      tempMarker.remove();
      tempMarker = null;
    }
  }

  // 关闭模态框
  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');

    // 重置位置选择器
    isPickingLocation = false;
    if (tempMarker) {
      tempMarker.remove();
      tempMarker = null;
    }
  }

  // 保存元素
  function saveItem() {
    const form = document.getElementById('item-form');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const itemData = {
      id: editingItem ? editingItem.id : Date.now().toString(),
      item_type: document.getElementById('item-type').value,
      name: document.getElementById('item-name').value,
      description: document.getElementById('item-description').value,
      start_datetime: formatDateTime(document.getElementById('item-start-time').value),
      end_datetime: formatDateTime(document.getElementById('item-end-time').value),
      cost: parseFloat(document.getElementById('item-cost').value) || 0,
      location: document.getElementById('item-location').value
    };

    // 解析位置
    const locationStr = itemData.location;
    if (locationStr) {
      const parts = locationStr.split(',');
      if (parts.length === 2) {
        itemData.latitude = parseFloat(parts[0].trim());
        itemData.longitude = parseFloat(parts[1].trim());
      }
    }

    // 如果是交通类型，保存轨迹数据
    if (itemData.item_type === 'transport' && elevationData) {
      itemData.elevationData = elevationData;
    }

    // 保存或更新元素
    if (editingItem) {
      const index = travelItems.findIndex(item => item.id === editingItem.id);
      travelItems[index] = itemData;
    } else {
      travelItems.push(itemData);
    }

    // 更新视图
    updateMarkers();
    renderTimeline();
    renderItemsList();

    // 关闭模态框
    closeModal('item-modal');
    showToast('保存成功', 'success');
  }

  // 格式化时间为ISO 8601格式
  function formatDateTime(datetime) {
    if (!datetime) return null;

    // 如果已经包含秒，直接添加时区
    if (datetime.length === 19) { // YYYY-MM-DDTHH:mm:ss
      return datetime + 'Z';
    }

    // 如果只有分钟，添加秒和时区
    if (datetime.length === 16) { // YYYY-MM-DDTHH:mm
      return datetime + ':00Z';
    }

    // 其他情况，尝试解析并格式化
    const date = new Date(datetime);
    return date.toISOString();
  }

  // 更新地图标记
  function updateMarkers() {
    // 清除现有标记
    markers.forEach(marker => marker.remove());
    markers = [];

    // 添加新标记
    travelItems.forEach(item => {
      if (item.latitude && item.longitude) {
        const el = document.createElement('div');
        el.className = 'map-marker';
        el.style.cssText = `
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        background: ${getItemColor(item.item_type)};
                        border: 3px solid white;
                        cursor: pointer;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
        el.innerHTML = `<i class="fas ${getItemIcon(item.item_type)}" style="color: white; font-size: 16px;"></i>`;

        const popup = new maplibregl.Popup({ offset: 25 })
                .setHTML(`
                            <div style="padding: 8px;">
                                <h4 style="margin: 0 0 8px 0;">${item.name}</h4>
                                ${item.description ? `<p style="margin: 0; color: #718096; font-size: 14px;">${item.description}</p>` : ''}
                                ${item.cost ? `<p style="margin: 8px 0 0 0; color: #f56565; font-weight: 600;">¥${item.cost}</p>` : ''}
                                ${item.elevationData ? `
                                    <div style="margin-top: 10px;">
                                        <canvas id="popup-elevation-${item.id}" width="200" height="100"></canvas>
                                    </div>
                                ` : ''}
                            </div>
                        `);

        const marker = new maplibregl.Marker({ element: el })
                .setLngLat([item.longitude, item.latitude])
                .setPopup(popup)
                .addTo(map);

        // 如果有海拔数据，在弹出窗口打开时绘制图表
        if (item.elevationData) {
          popup.on('open', () => {
            setTimeout(() => {
              const canvas = document.getElementById(`popup-elevation-${item.id}`);
              if (canvas) {
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: item.elevationData.map(d => `${d.distance.toFixed(1)}`),
                    datasets: [{
                      data: item.elevationData.map(d => d.elevation),
                      borderColor: '#667eea',
                      backgroundColor: 'rgba(102, 126, 234, 0.1)',
                      fill: true,
                      tension: 0.4,
                      pointRadius: 0
                    }]
                  },
                  options: {
                    responsive: false,
                    plugins: {
                      legend: { display: false }
                    },
                    scales: {
                      x: { display: false },
                      y: { display: false }
                    }
                  }
                });
              }
            }, 100);
          });
        }

        markers.push(marker);

        el.addEventListener('click', () => {
          selectedItem = item;
          renderItemsList();
        });
      }
    });
  }

  // 适应地图边界
  function fitMapBounds() {
    if (travelItems.length === 0) return;

    const bounds = new maplibregl.LngLatBounds();
    let hasPoints = false;

    travelItems.forEach(item => {
      if (item.latitude && item.longitude) {
        bounds.extend([item.longitude, item.latitude]);
        hasPoints = true;
      }
    });

    if (hasPoints) {
      map.fitBounds(bounds, { padding: 50 });
    }
  }

  // 渲染时间轴
  function renderTimeline() {
    const container = document.getElementById('timeline-view');
    const itemsByDate = {};

    travelItems.forEach(item => {
      if (item.start_datetime) {
        const date = item.start_datetime.split('T')[0];
        if (!itemsByDate[date]) {
          itemsByDate[date] = [];
        }
        itemsByDate[date].push(item);
      }
    });

    let html = '';
    Object.keys(itemsByDate).sort().forEach(date => {
      html += `
                    <div class="timeline-day">
                        <div class="timeline-date">${dayjs(date).format('MM月DD日 dddd')}</div>
                `;

      itemsByDate[date].sort((a, b) => new Date(a.start_datetime) - new Date(b.start_datetime))
              .forEach(item => {
                html += `
                            <div class="timeline-item" onclick="selectItem('${item.id}')">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${getItemColor(item.item_type)}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas ${getItemIcon(item.item_type)}" style="color: white;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">${item.name}</div>
                                    <div style="font-size: 14px; color: var(--gray-color);">
                                        ${dayjs(item.start_datetime).format('HH:mm')} - ${dayjs(item.end_datetime).format('HH:mm')}
                                    </div>
                                    ${item.description ? `<div style="font-size: 14px; color: var(--gray-color); margin-top: 4px;">${item.description}</div>` : ''}
                                </div>
                                ${item.cost ? `<div style="color: var(--danger-color); font-weight: 600;">¥${item.cost}</div>` : ''}
                            </div>
                        `;
              });

      html += '</div>';
    });

    container.innerHTML = html || '<div style="text-align: center; color: var(--gray-color); padding: 40px;">暂无行程安排</div>';
  }

  // 渲染甘特图
  function renderGantt() {
    const container = document.getElementById('gantt-view');
    container.innerHTML = '<div id="gantt-chart"></div>';

    const tasks = travelItems
            .filter(item => item.start_datetime && item.end_datetime)
            .map(item => ({
              id: item.id,
              name: item.name,
              start: item.start_datetime.split('T')[0],
              end: item.end_datetime.split('T')[0],
              progress: 0,
              custom_class: `bar-${item.item_type}`
            }));

    if (tasks.length > 0) {
      ganttChart = new Gantt('#gantt-chart', tasks, {
        view_mode: 'Day',
        date_format: 'YYYY-MM-DD',
        custom_popup_html: function(task) {
          const item = travelItems.find(i => i.id === task.id);
          return `
                            <div style="padding: 10px;">
                                <h5>${item.name}</h5>
                                <p>${dayjs(item.start_datetime).format('MM-DD HH:mm')} - ${dayjs(item.end_datetime).format('MM-DD HH:mm')}</p>
                                ${item.cost ? `<p>费用: ¥${item.cost}</p>` : ''}
                            </div>
                        `;
        }
      });
    } else {
      container.innerHTML = '<div style="text-align: center; color: var(--gray-color); padding: 40px;">暂无可显示的甘特图数据</div>';
    }
  }

  // 渲染元素列表
  function renderItemsList() {
    const container = document.getElementById('items-list');
    let html = '';

    travelItems.forEach(item => {
      const isSelected = selectedItem && selectedItem.id === item.id;
      html += `
                    <div class="item-card ${isSelected ? 'selected' : ''}" onclick="selectItem('${item.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600;">${item.name}</div>
                            <div style="padding: 4px 8px; background: ${getItemColor(item.item_type)}; color: white; border-radius: 4px; font-size: 12px;">
                                ${getItemTypeName(item.item_type)}
                            </div>
                        </div>
                        ${item.description ? `<div style="font-size: 14px; color: var(--gray-color); margin-bottom: 8px;">${item.description}</div>` : ''}
                        <div style="font-size: 14px; color: var(--gray-color);">
                            ${item.start_datetime ? `<i class="fas fa-clock"></i> ${dayjs(item.start_datetime).format('MM-DD HH:mm')}` : ''}
                            ${item.cost ? `<span style="margin-left: 12px;"><i class="fas fa-yuan-sign"></i> ${item.cost}</span>` : ''}
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-secondary" onclick="editItem('${item.id}'); event.stopPropagation();">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="deleteItem('${item.id}'); event.stopPropagation();" style="color: var(--danger-color);">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;
    });

    container.innerHTML = html || '<div style="text-align: center; color: var(--gray-color); padding: 40px;">暂无旅游元素</div>';
  }

  // 选择元素
  function selectItem(itemId) {
    selectedItem = travelItems.find(item => item.id === itemId);
    renderItemsList();

    if (selectedItem && selectedItem.latitude && selectedItem.longitude) {
      map.flyTo({
        center: [selectedItem.longitude, selectedItem.latitude],
        zoom: 14
      });
    }
  }

  // 编辑元素
  function editItem(itemId) {
    editingItem = travelItems.find(item => item.id === itemId);
    if (!editingItem) return;

    document.getElementById('modal-title').textContent = '编辑旅游元素';
    document.getElementById('item-type').value = editingItem.item_type;
    document.getElementById('item-name').value = editingItem.name;
    document.getElementById('item-description').value = editingItem.description || '';

    // 处理时间格式
    if (editingItem.start_datetime) {
      const startTime = editingItem.start_datetime.replace('Z', '').substring(0, 16);
      document.getElementById('item-start-time').value = startTime;
    }
    if (editingItem.end_datetime) {
      const endTime = editingItem.end_datetime.replace('Z', '').substring(0, 16);
      document.getElementById('item-end-time').value = endTime;
    }

    document.getElementById('item-cost').value = editingItem.cost || '';

    if (editingItem.latitude && editingItem.longitude) {
      document.getElementById('item-location').value = `${editingItem.latitude}, ${editingItem.longitude}`;
    }

    onItemTypeChange(editingItem.item_type);

    document.getElementById('item-modal').classList.add('active');
  }

  // 删除元素
  function deleteItem(itemId) {
    if (confirm('确定要删除这个元素吗？')) {
      travelItems = travelItems.filter(item => item.id !== itemId);
      if (selectedItem && selectedItem.id === itemId) {
        selectedItem = null;
      }
      updateMarkers();
      renderTimeline();
      renderItemsList();
      showToast('删除成功', 'success');
    }
  }

  // 获取元素颜色
  function getItemColor(type) {
    const colors = {
      accommodation: '#805ad5',
      transport: '#3182ce',
      attraction: '#48bb78',
      photo_spot: '#ed8936',
      rest_area: '#38b2ac',
      other: '#718096'
    };
    return colors[type] || colors.other;
  }

  // 获取元素图标
  function getItemIcon(type) {
    const icons = {
      accommodation: 'fa-bed',
      transport: 'fa-plane',
      attraction: 'fa-mountain',
      photo_spot: 'fa-camera',
      rest_area: 'fa-coffee',
      other: 'fa-ellipsis-h'
    };
    return icons[type] || icons.other;
  }

  // 获取元素类型名称
  function getItemTypeName(type) {
    const names = {
      accommodation: '住宿',
      transport: '交通',
      attraction: '景点',
      photo_spot: '拍照点',
      rest_area: '休息点',
      other: '其他'
    };
    return names[type] || names.other;
  }

  // 显示提示消息
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideUp 0.3s reverse';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // 加载示例数据
  function loadSampleData() {
    travelItems = [
      {
        id: '1',
        item_type: 'accommodation',
        name: '亚丁村藏家客栈',
        description: '位于亚丁村中心，藏式风格装修',
        latitude: 28.45,
        longitude: 100.35,
        start_datetime: '2024-05-01T14:00:00Z',
        end_datetime: '2024-05-03T12:00:00Z',
        cost: 600
      },
      {
        id: '2',
        item_type: 'transport',
        name: '成都-稻城航班',
        description: '国航CA4215',
        start_datetime: '2024-05-01T08:00:00Z',
        end_datetime: '2024-05-01T09:30:00Z',
        cost: 1200
      },
      {
        id: '3',
        item_type: 'attraction',
        name: '牛奶海',
        description: '央迈勇神山脚下的古冰川湖',
        latitude: 28.38,
        longitude: 100.32,
        start_datetime: '2024-05-02T09:00:00Z',
        end_datetime: '2024-05-02T15:00:00Z',
        cost: 150
      }
    ];

    updateMarkers();
    renderTimeline();
    renderItemsList();
    restorePanelStates();
  }
</script>
</body>
</html>