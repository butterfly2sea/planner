<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>稻城亚丁智能旅游规划系统</title>

  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.6.2/dist/maplibre-gl.css' />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --danger-color: #f56565;
      --info-color: #4299e1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 头部样式 */
    .header {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #2d3748;
      font-size: 32px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header .subtitle {
      color: #718096;
      font-size: 16px;
    }

    /* 标签页导航 */
    .tab-nav {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      background: white;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: #4a5568;
      font-size: 16px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      background: #f7fafc;
    }

    .tab-btn.active {
      background: var(--primary-gradient);
      color: white;
    }

    /* 主内容区域 */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .panel {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .panel h2 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* 地图容器 */
    #map {
      width: 100%;
      height: 600px;
      border-radius: 12px;
      overflow: hidden;
    }

    /* 时间轴样式 */
    .timeline-container {
      height: 600px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .timeline-day {
      margin-bottom: 24px;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
    }

    .timeline-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }

    .timeline-day-date {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }

    .timeline-day-summary {
      font-size: 14px;
      color: #718096;
    }

    .timeline-item {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      background: white;
      padding: 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .timeline-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .timeline-item.selected {
      background: var(--primary-gradient);
      color: white;
    }

    .timeline-time {
      flex-shrink: 0;
      width: 80px;
      font-weight: 600;
      color: #4a5568;
    }

    .timeline-item.selected .timeline-time {
      color: white;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-content h4 {
      margin-bottom: 4px;
      font-size: 16px;
    }

    .timeline-content p {
      font-size: 14px;
      opacity: 0.8;
    }

    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    /* 元素类型图标样式 */
    .icon-accommodation { background: #805ad5; color: white; }
    .icon-transport { background: #3182ce; color: white; }
    .icon-attraction { background: #48bb78; color: white; }
    .icon-photo-spot { background: #ed8936; color: white; }
    .icon-rest-area { background: #38b2ac; color: white; }
    .icon-checkpoint { background: #e53e3e; color: white; }
    .icon-other { background: #718096; color: white; }

    /* 侧边栏 */
    .sidebar {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .item-type-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid #e2e8f0;
      background: white;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .filter-chip:hover {
      border-color: #cbd5e0;
    }

    .filter-chip.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    /* 元素列表 */
    .items-list {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .item-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .item-card:hover {
      background: white;
      border-color: #e2e8f0;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .item-card.selected {
      border-color: #667eea;
      background: white;
    }

    .item-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }

    .item-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
    }

    .item-card-type {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: white;
    }

    .item-card-details {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #718096;
    }

    .item-card-details i {
      width: 16px;
    }

    /* 按钮样式 */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    /* 浮动操作按钮 */
    .fab {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--primary-gradient);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s;
      z-index: 100;
    }

    .fab:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
    }

    /* 模态框 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }

    .modal.active {
      display: flex;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 24px;
      color: #2d3748;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #f7fafc;
      color: #4a5568;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #e2e8f0;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* 表单样式 */
    .form-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e2e8f0;
    }

    .form-tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: #718096;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .form-tab:hover {
      color: #4a5568;
    }

    .form-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #4a5568;
      font-size: 14px;
      font-weight: 500;
    }

    .form-group label .required {
      color: var(--danger-color);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* 海拔图表 */
    .elevation-chart {
      width: 100%;
      height: 200px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-top: 8px;
      background: #f8f9fa;
    }

    /* 图片上传区域 */
    .upload-area {
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }

    .upload-area:hover {
      border-color: #667eea;
      background: white;
    }

    .upload-area.dragging {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .upload-icon {
      font-size: 48px;
      color: #cbd5e0;
      margin-bottom: 16px;
    }

    .upload-text {
      color: #718096;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .upload-hint {
      color: #a0aec0;
      font-size: 14px;
    }

    /* 图片预览 */
    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .image-preview-item {
      position: relative;
      padding-bottom: 100%;
      border-radius: 8px;
      overflow: hidden;
      background: #f7fafc;
    }

    .image-preview-item img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s;
    }

    .image-preview-item:hover .image-preview-remove {
      opacity: 1;
    }

    /* 标签输入 */
    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      min-height: 48px;
    }

    .tag-chip {
      padding: 4px 12px;
      background: #edf2f7;
      border-radius: 16px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag-chip button {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tag-chip button:hover {
      color: var(--danger-color);
    }

    .tags-input input {
      border: none;
      outline: none;
      flex: 1;
      min-width: 100px;
      padding: 4px;
    }

    /* 统计卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 12px;
    }

    .stat-card-value {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .stat-card-label {
      font-size: 14px;
      color: #718096;
    }

    /* 响应式设计 */
    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .header h1 {
        font-size: 24px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }

      .fab {
        width: 56px;
        height: 56px;
        font-size: 20px;
      }
    }

    /* 加载动画 */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    /* 提示信息 */
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      padding: 16px 24px;
      background: #2d3748;
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 3000;
      animation: slideInUp 0.3s;
    }

    @keyframes slideInUp {
      from { transform: translateX(-50%) translateY(100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .toast.success { background: var(--success-color); }
    .toast.warning { background: var(--warning-color); }
    .toast.error { background: var(--danger-color); }
  </style>
</head>
<body>
<div class="container">
  <!-- 头部 -->
  <div class="header">
    <h1>
      <i class="fas fa-mountain"></i>
      稻城亚丁智能旅游规划系统
    </h1>
    <div class="subtitle">全方位规划您的完美旅程 - 住宿、交通、景点、美食一站式管理</div>
  </div>

  <!-- 统计信息 -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-icon icon-accommodation">
        <i class="fas fa-bed"></i>
      </div>
      <div class="stat-card-value" id="stat-accommodation">0</div>
      <div class="stat-card-label">住宿安排</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-icon icon-transport">
        <i class="fas fa-plane"></i>
      </div>
      <div class="stat-card-value" id="stat-transport">0</div>
      <div class="stat-card-label">交通计划</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-icon icon-attraction">
        <i class="fas fa-camera"></i>
      </div>
      <div class="stat-card-value" id="stat-attraction">0</div>
      <div class="stat-card-label">景点打卡</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-icon" style="background: #f56565;">
        <i class="fas fa-yuan-sign"></i>
      </div>
      <div class="stat-card-value" id="stat-budget">0</div>
      <div class="stat-card-label">预算总计</div>
    </div>
  </div>

  <!-- 标签页导航 -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('overview')">
      <i class="fas fa-th-large"></i> 总览
    </button>
    <button class="tab-btn" onclick="switchTab('map')">
      <i class="fas fa-map-marked-alt"></i> 地图
    </button>
    <button class="tab-btn" onclick="switchTab('timeline')">
      <i class="fas fa-calendar-alt"></i> 时间轴
    </button>
    <button class="tab-btn" onclick="switchTab('budget')">
      <i class="fas fa-calculator"></i> 预算
    </button>
    <button class="tab-btn" onclick="switchTab('photos')">
      <i class="fas fa-images"></i> 相册
    </button>
  </div>

  <!-- 主内容区 -->
  <div class="main-content">
    <!-- 地图面板 -->
    <div class="panel">
      <h2>
        <i class="fas fa-map"></i>
        地图视图
      </h2>
      <div id="map"></div>
      <div style="margin-top: 16px; display: flex; gap: 12px;">
        <button class="btn btn-primary btn-sm" onclick="fitMapBounds()">
          <i class="fas fa-compress"></i> 适应视图
        </button>
        <button class="btn btn-secondary btn-sm" onclick="toggleMapStyle()">
          <i class="fas fa-layer-group"></i> 切换图层
        </button>
      </div>
    </div>

    <!-- 时间轴面板 -->
    <div class="panel">
      <h2>
        <i class="fas fa-stream"></i>
        行程时间轴
      </h2>
      <div class="timeline-container" id="timeline-container">
        <!-- 时间轴内容动态生成 -->
      </div>
    </div>
  </div>

  <!-- 侧边栏 -->
  <div class="sidebar">
    <h2>
      <i class="fas fa-list"></i>
      旅游元素
    </h2>

    <!-- 类型过滤 -->
    <div class="item-type-filter">
      <div class="filter-chip active" data-type="all">
        <i class="fas fa-border-all"></i> 全部
      </div>
      <div class="filter-chip" data-type="accommodation">
        <i class="fas fa-bed"></i> 住宿
      </div>
      <div class="filter-chip" data-type="transport">
        <i class="fas fa-plane"></i> 交通
      </div>
      <div class="filter-chip" data-type="attraction">
        <i class="fas fa-mountain"></i> 景点
      </div>
      <div class="filter-chip" data-type="photo_spot">
        <i class="fas fa-camera"></i> 拍照点
      </div>
      <div class="filter-chip" data-type="rest_area">
        <i class="fas fa-coffee"></i> 休息点
      </div>
      <div class="filter-chip" data-type="other">
        <i class="fas fa-ellipsis-h"></i> 其他
      </div>
    </div>

    <!-- 元素列表 -->
    <div class="items-list" id="items-list">
      <!-- 动态生成内容 -->
    </div>

    <!-- 操作按钮 -->
    <div style="margin-top: 20px; display: flex; gap: 12px;">
      <button class="btn btn-primary" onclick="openAddItemModal()">
        <i class="fas fa-plus"></i> 添加元素
      </button>
      <button class="btn btn-secondary" onclick="autoArrangeItems()">
        <i class="fas fa-magic"></i> 智能排布
      </button>
    </div>
  </div>
</div>

<!-- 浮动操作按钮 -->
<button class="fab" onclick="openAddItemModal()">
  <i class="fas fa-plus"></i>
</button>

<!-- 添加/编辑元素模态框 -->
<div class="modal" id="item-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">添加旅游元素</h3>
      <button class="modal-close" onclick="closeModal('item-modal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <!-- 表单标签页 -->
      <div class="form-tabs">
        <button class="form-tab active" onclick="switchFormTab('basic')">基本信息</button>
        <button class="form-tab" onclick="switchFormTab('details')">详细信息</button>
        <button class="form-tab" onclick="switchFormTab('media')">图片标注</button>
        <button class="form-tab" onclick="switchFormTab('relations')">关联设置</button>
      </div>

      <form id="item-form">
        <!-- 基本信息 -->
        <div class="form-section active" id="form-basic">
          <div class="form-row">
            <div class="form-group">
              <label>元素类型 <span class="required">*</span></label>
              <select id="item-type" onchange="onItemTypeChange()">
                <option value="accommodation">住宿</option>
                <option value="transport">交通</option>
                <option value="attraction">景点</option>
                <option value="photo_spot">拍照点</option>
                <option value="rest_area">休息点</option>
                <option value="checkpoint">检查站</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label>名称 <span class="required">*</span></label>
              <input type="text" id="item-name" required>
            </div>
          </div>

          <div class="form-group full-width">
            <label>描述</label>
            <textarea id="item-description"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>开始时间</label>
              <input type="datetime-local" id="item-start-time">
            </div>
            <div class="form-group">
              <label>结束时间</label>
              <input type="datetime-local" id="item-end-time">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>预算费用（元）</label>
              <input type="number" id="item-cost" min="0" step="0.01">
            </div>
            <div class="form-group">
              <label>优先级</label>
              <select id="item-priority">
                <option value="1">非常低</option>
                <option value="2">低</option>
                <option value="3" selected>中等</option>
                <option value="4">高</option>
                <option value="5">非常高</option>
              </select>
            </div>
          </div>

          <div class="form-group full-width">
            <label>地址</label>
            <input type="text" id="item-address" placeholder="点击地图选择位置或输入地址">
          </div>

          <div class="form-group full-width">
            <label>标签</label>
            <div class="tags-input" id="tags-input">
              <input type="text" placeholder="输入标签后按回车">
            </div>
          </div>
        </div>

        <!-- 详细信息（根据类型动态显示） -->
        <div class="form-section" id="form-details">
          <!-- 住宿详情 -->
          <div id="details-accommodation" class="details-section">
            <div class="form-row">
              <div class="form-group">
                <label>酒店名称</label>
                <input type="text" id="hotel-name">
              </div>
              <div class="form-group">
                <label>房型</label>
                <input type="text" id="room-type" placeholder="如：标准双床房">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>入住时间</label>
                <input type="time" id="check-in-time" value="14:00">
              </div>
              <div class="form-group">
                <label>退房时间</label>
                <input type="time" id="check-out-time" value="12:00">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>预订平台</label>
                <select id="booking-platform">
                  <option value="">请选择</option>
                  <option value="booking.com">Booking.com</option>
                  <option value="agoda">Agoda</option>
                  <option value="ctrip">携程</option>
                  <option value="direct">酒店直订</option>
                </select>
              </div>
              <div class="form-group">
                <label>订单号</label>
                <input type="text" id="booking-number">
              </div>
            </div>
          </div>

          <!-- 交通详情 -->
          <div id="details-transport" class="details-section" style="display:none;">
            <div class="form-row">
              <div class="form-group">
                <label>交通类型</label>
                <select id="transport-type" onchange="onTransportTypeChange()">
                  <option value="flight">飞机</option>
                  <option value="train">火车</option>
                  <option value="bus">大巴</option>
                  <option value="self_drive">自驾</option>
                  <option value="taxi">出租车</option>
                </select>
              </div>
              <div class="form-group">
                <label>承运商</label>
                <input type="text" id="carrier-name" placeholder="如：国航CA1234">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>出发地</label>
                <input type="text" id="departure-location">
              </div>
              <div class="form-group">
                <label>目的地</label>
                <input type="text" id="arrival-location">
              </div>
            </div>

            <!-- 自驾特有选项 -->
            <div id="self-drive-options" style="display:none;">
              <div class="form-group full-width">
                <label>路线海拔变化</label>
                <div class="elevation-chart" id="elevation-chart">
                  <canvas id="elevation-canvas"></canvas>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>预计油费（元）</label>
                  <input type="number" id="fuel-cost" min="0">
                </div>
                <div class="form-group">
                  <label>过路费（元）</label>
                  <input type="number" id="toll-cost" min="0">
                </div>
              </div>
            </div>
          </div>

          <!-- 景点详情 -->
          <div id="details-attraction" class="details-section" style="display:none;">
            <div class="form-row">
              <div class="form-group">
                <label>景点类型</label>
                <select id="attraction-type">
                  <option value="scenic_spot">风景名胜</option>
                  <option value="viewpoint">观景台</option>
                  <option value="cultural">文化遗址</option>
                  <option value="religious">宗教场所</option>
                </select>
              </div>
              <div class="form-group">
                <label>门票价格（元）</label>
                <input type="number" id="ticket-price" min="0">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>最佳游览时间</label>
                <input type="text" id="best-visit-time" placeholder="如：日出时分">
              </div>
              <div class="form-group">
                <label>建议游览时长（小时）</label>
                <input type="number" id="recommended-duration" min="0.5" step="0.5">
              </div>
            </div>
            <div class="form-group full-width">
              <label>摄影建议</label>
              <textarea id="photography-tips" placeholder="最佳拍摄位置、光线条件等"></textarea>
            </div>
          </div>
        </div>

        <!-- 图片标注 -->
        <div class="form-section" id="form-media">
          <div class="upload-area" id="upload-area">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <div class="upload-text">点击或拖拽上传图片</div>
            <div class="upload-hint">支持 JPG、PNG、GIF，单个文件最大 5MB</div>
            <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
          </div>
          <div class="image-preview-grid" id="image-preview">
            <!-- 图片预览动态生成 -->
          </div>
        </div>

        <!-- 关联设置 -->
        <div class="form-section" id="form-relations">
          <div class="form-group">
            <label>关联元素</label>
            <select id="related-items" multiple style="height: 150px;">
              <!-- 动态加载其他元素 -->
            </select>
            <small style="color: #718096;">按住 Ctrl/Cmd 键可多选</small>
          </div>
          <div class="form-group">
            <label>关联类型</label>
            <select id="relation-type">
              <option value="near_to">附近</option>
              <option value="requires">需要</option>
              <option value="conflicts_with">冲突</option>
              <option value="alternative_to">替代</option>
              <option value="included_in">包含于</option>
            </select>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeModal('item-modal')">
        取消
      </button>
      <button type="button" class="btn btn-primary" onclick="saveItem()">
        <i class="fas fa-save"></i> 保存
      </button>
    </div>
  </div>
</div>

<!-- MapLibre GL JS -->
<script src='https://unpkg.com/maplibre-gl@5.6.2/dist/maplibre-gl.js'></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ==================== 全局变量 ====================
  let map = null;
  let travelItems = [];
  let selectedItem = null;
  let markers = new Map();
  let currentTab = 'overview';
  let editingItem = null;
  let uploadedImages = [];

  // 元素类型配置
  const ITEM_TYPE_CONFIG = {
    accommodation: {
      name: '住宿',
      icon: 'fa-bed',
      color: '#805ad5',
      markerColor: '#805ad5'
    },
    transport: {
      name: '交通',
      icon: 'fa-plane',
      color: '#3182ce',
      markerColor: '#3182ce'
    },
    attraction: {
      name: '景点',
      icon: 'fa-mountain',
      color: '#48bb78',
      markerColor: '#48bb78'
    },
    photo_spot: {
      name: '拍照点',
      icon: 'fa-camera',
      color: '#ed8936',
      markerColor: '#ed8936'
    },
    rest_area: {
      name: '休息点',
      icon: 'fa-coffee',
      color: '#38b2ac',
      markerColor: '#38b2ac'
    },
    checkpoint: {
      name: '检查站',
      icon: 'fa-shield-alt',
      color: '#e53e3e',
      markerColor: '#e53e3e'
    },
    other: {
      name: '其他',
      icon: 'fa-ellipsis-h',
      color: '#718096',
      markerColor: '#718096'
    }
  };

  // ==================== 初始化 ====================

  // 初始化地图
  function initMap() {
    map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          'osm-tiles': {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256
          }
        },
        layers: [{
          id: 'osm-tiles',
          type: 'raster',
          source: 'osm-tiles',
          minzoom: 0,
          maxzoom: 19
        }]
      },
      center: [100.3, 28.5], // 稻城亚丁中心坐标
      zoom: 11,
      attributionControl: false
    });

    // 添加导航控件
    map.addControl(new maplibregl.NavigationControl());

    // 添加定位控件
    map.addControl(new maplibregl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true
    }));

    // 地图点击事件
    map.on('click', (e) => {
      if (document.getElementById('item-modal').classList.contains('active')) {
        const {lng, lat} = e.lngLat;
        document.getElementById('item-address').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        // 如果是添加模式，在地图上添加临时标记
        if (!editingItem) {
          addTemporaryMarker(lng, lat);
        }
      }
    });

    // 加载示例数据
    loadSampleData();
  }

  // 加载示例数据
  function loadSampleData() {
    travelItems = [
      {
        id: '1',
        item_type: 'accommodation',
        name: '亚丁村藏家客栈',
        description: '位于亚丁村中心，藏式风格装修',
        latitude: 28.45,
        longitude: 100.35,
        start_datetime: '2024-05-01T14:00:00',
        end_datetime: '2024-05-03T12:00:00',
        cost: 600,
        details: {
          hotel_name: '亚丁村藏家客栈',
          room_type: '标准双床房',
          price_per_night: 300
        }
      },
      {
        id: '2',
        item_type: 'transport',
        name: '成都-稻城航班',
        description: '国航CA4215',
        start_datetime: '2024-05-01T08:00:00',
        end_datetime: '2024-05-01T09:30:00',
        cost: 1200,
        details: {
          transport_type: 'flight',
          departure_location: '成都双流机场',
          arrival_location: '稻城亚丁机场',
          carrier_name: '中国国航'
        }
      },
      {
        id: '3',
        item_type: 'attraction',
        name: '牛奶海',
        description: '央迈勇神山脚下的古冰川湖',
        latitude: 28.38,
        longitude: 100.32,
        start_datetime: '2024-05-02T08:00:00',
        end_datetime: '2024-05-02T12:00:00',
        cost: 150,
        details: {
          attraction_type: 'scenic_spot',
          ticket_price: 150,
          recommended_duration: 4
        }
      },
      {
        id: '4',
        item_type: 'photo_spot',
        name: '洛绒牛场观景台',
        description: '拍摄三座神山的最佳位置',
        latitude: 28.40,
        longitude: 100.30,
        start_datetime: '2024-05-02T14:00:00',
        end_datetime: '2024-05-02T16:00:00',
        details: {
          best_visit_time: '日出和日落时分',
          photography_tips: '使用广角镜头可以同时拍摄三座神山'
        }
      }
    ];

    // 渲染数据
    renderMarkers();
    renderItemsList();
    renderTimeline();
    updateStatistics();
  }

  // ==================== 地图相关功能 ====================

  // 渲染地图标记
  function renderMarkers() {
    // 清除现有标记
    markers.forEach(marker => marker.remove());
    markers.clear();

    // 添加新标记
    travelItems.forEach(item => {
      if (item.latitude && item.longitude) {
        const config = ITEM_TYPE_CONFIG[item.item_type];

        // 创建标记元素
        const el = document.createElement('div');
        el.className = 'map-marker';
        el.style.width = '36px';
        el.style.height = '36px';
        el.style.borderRadius = '50%';
        el.style.background = config.markerColor;
        el.style.border = '3px solid white';
        el.style.cursor = 'pointer';
        el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.innerHTML = `<i class="fas ${config.icon}" style="color: white; font-size: 16px;"></i>`;

        // 创建标记
        const marker = new maplibregl.Marker({ element: el })
                .setLngLat([item.longitude, item.latitude])
                .setPopup(new maplibregl.Popup({ offset: 25 })
                        .setHTML(createPopupContent(item)))
                .addTo(map);

        // 点击事件
        el.addEventListener('click', () => selectItem(item.id));

        markers.set(item.id, marker);
      }
    });
  }

  // 创建弹出窗口内容
  function createPopupContent(item) {
    const config = ITEM_TYPE_CONFIG[item.item_type];
    return `
        <div style="padding: 8px;">
            <h4 style="margin: 0 0 8px 0; color: #2d3748;">
                <i class="fas ${config.icon}" style="color: ${config.color};"></i>
                ${item.name}
            </h4>
            <p style="margin: 0 0 8px 0; color: #718096; font-size: 14px;">
                ${item.description || '暂无描述'}
            </p>
            ${item.cost ? `<p style="margin: 0; color: #e53e3e; font-weight: 600;">¥${item.cost}</p>` : ''}
        </div>
    `;
  }

  // 添加临时标记
  function addTemporaryMarker(lng, lat) {
    // 移除之前的临时标记
    if (window.tempMarker) {
      window.tempMarker.remove();
    }

    const el = document.createElement('div');
    el.style.width = '20px';
    el.style.height = '20px';
    el.style.borderRadius = '50%';
    el.style.background = '#667eea';
    el.style.border = '2px solid white';
    el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';

    window.tempMarker = new maplibregl.Marker({ element: el })
            .setLngLat([lng, lat])
            .addTo(map);
  }

  // 适应地图边界
  function fitMapBounds() {
    const bounds = new maplibregl.LngLatBounds();
    let hasPoints = false;

    travelItems.forEach(item => {
      if (item.latitude && item.longitude) {
        bounds.extend([item.longitude, item.latitude]);
        hasPoints = true;
      }
    });

    if (hasPoints) {
      map.fitBounds(bounds, { padding: 50 });
    }
  }

  // ==================== 列表渲染 ====================

  // 渲染元素列表
  function renderItemsList(filterType = 'all') {
    const container = document.getElementById('items-list');
    container.innerHTML = '';

    const filteredItems = filterType === 'all'
            ? travelItems
            : travelItems.filter(item => item.item_type === filterType);

    filteredItems.forEach(item => {
      const config = ITEM_TYPE_CONFIG[item.item_type];
      const card = document.createElement('div');
      card.className = 'item-card';
      card.dataset.id = item.id;

      if (selectedItem && selectedItem.id === item.id) {
        card.classList.add('selected');
      }

      card.innerHTML = `
            <div class="item-card-header">
                <div class="item-card-title">${item.name}</div>
                <div class="item-card-type" style="background: ${config.color};">
                    ${config.name}
                </div>
            </div>
            <div class="item-card-details">
                ${item.start_datetime ? `<span><i class="fas fa-clock"></i> ${formatDateTime(item.start_datetime)}</span>` : ''}
                ${item.cost ? `<span><i class="fas fa-yuan-sign"></i> ${item.cost}</span>` : ''}
            </div>
        `;

      card.addEventListener('click', () => selectItem(item.id));
      container.appendChild(card);
    });
  }

  // 渲染时间轴
  function renderTimeline() {
    const container = document.getElementById('timeline-container');
    container.innerHTML = '';

    // 按日期分组
    const itemsByDate = {};
    travelItems.forEach(item => {
      if (item.start_datetime) {
        const date = item.start_datetime.split('T')[0];
        if (!itemsByDate[date]) {
          itemsByDate[date] = [];
        }
        itemsByDate[date].push(item);
      }
    });

    // 排序并渲染每一天
    Object.keys(itemsByDate).sort().forEach(date => {
      const dayContainer = document.createElement('div');
      dayContainer.className = 'timeline-day';

      const dayItems = itemsByDate[date].sort((a, b) =>
              new Date(a.start_datetime) - new Date(b.start_datetime)
      );

      const totalCost = dayItems.reduce((sum, item) => sum + (item.cost || 0), 0);

      dayContainer.innerHTML = `
            <div class="timeline-day-header">
                <div class="timeline-day-date">${formatDate(date)}</div>
                <div class="timeline-day-summary">
                    ${dayItems.length} 个项目 · ¥${totalCost}
                </div>
            </div>
        `;

      dayItems.forEach(item => {
        const config = ITEM_TYPE_CONFIG[item.item_type];
        const timelineItem = document.createElement('div');
        timelineItem.className = 'timeline-item';
        timelineItem.dataset.id = item.id;

        if (selectedItem && selectedItem.id === item.id) {
          timelineItem.classList.add('selected');
        }

        timelineItem.innerHTML = `
                <div class="timeline-icon icon-${item.item_type}">
                    <i class="fas ${config.icon}"></i>
                </div>
                <div class="timeline-time">
                    ${formatTime(item.start_datetime)}
                </div>
                <div class="timeline-content">
                    <h4>${item.name}</h4>
                    <p>${item.description || config.name}</p>
                </div>
            `;

        timelineItem.addEventListener('click', () => selectItem(item.id));
        dayContainer.appendChild(timelineItem);
      });

      container.appendChild(dayContainer);
    });
  }

  // ==================== 交互功能 ====================

  // 选择元素
  function selectItem(itemId) {
    selectedItem = travelItems.find(item => item.id === itemId);

    // 更新列表选中状态
    document.querySelectorAll('.item-card').forEach(card => {
      card.classList.toggle('selected', card.dataset.id === itemId);
    });

    // 更新时间轴选中状态
    document.querySelectorAll('.timeline-item').forEach(item => {
      item.classList.toggle('selected', item.dataset.id === itemId);
    });

    // 地图定位
    if (selectedItem && selectedItem.latitude && selectedItem.longitude) {
      map.flyTo({
        center: [selectedItem.longitude, selectedItem.latitude],
        zoom: 14
      });

      // 打开弹出窗口
      const marker = markers.get(itemId);
      if (marker) {
        marker.togglePopup();
      }
    }
  }

  // 切换标签页
  function switchTab(tabName) {
    currentTab = tabName;

    // 更新标签按钮状态
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // 根据标签页显示不同内容
    // 这里可以根据需要添加更多标签页的逻辑
  }

  // 切换表单标签页
  function switchFormTab(tabName) {
    // 更新标签按钮状态
    document.querySelectorAll('.form-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // 显示对应的表单部分
    document.querySelectorAll('.form-section').forEach(section => {
      section.classList.remove('active');
    });
    document.getElementById(`form-${tabName}`).classList.add('active');
  }

  // 类型过滤
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      // 更新选中状态
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');

      // 重新渲染列表
      renderItemsList(chip.dataset.type);
    });
  });

  // ==================== 模态框操作 ====================

  // 打开添加元素模态框
  function openAddItemModal() {
    editingItem = null;
    document.getElementById('modal-title').textContent = '添加旅游元素';
    document.getElementById('item-form').reset();
    document.getElementById('item-modal').classList.add('active');

    // 切换到基本信息标签
    document.querySelectorAll('.form-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
    document.querySelector('.form-tab').classList.add('active');
    document.getElementById('form-basic').classList.add('active');

    // 显示对应的详情表单
    onItemTypeChange();
  }

  // 关闭模态框
  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');

    // 清除临时标记
    if (window.tempMarker) {
      window.tempMarker.remove();
      window.tempMarker = null;
    }
  }

  // 元素类型改变
  function onItemTypeChange() {
    const itemType = document.getElementById('item-type').value;

    // 隐藏所有详情部分
    document.querySelectorAll('.details-section').forEach(section => {
      section.style.display = 'none';
    });

    // 显示对应的详情部分
    const detailsSection = document.getElementById(`details-${itemType}`);
    if (detailsSection) {
      detailsSection.style.display = 'block';
    }
  }

  // 交通类型改变
  function onTransportTypeChange() {
    const transportType = document.getElementById('transport-type').value;
    const selfDriveOptions = document.getElementById('self-drive-options');

    if (transportType === 'self_drive') {
      selfDriveOptions.style.display = 'block';
      // 初始化海拔图表
      initElevationChart();
    } else {
      selfDriveOptions.style.display = 'none';
    }
  }

  // 保存元素
  function saveItem() {
    const formData = {
      id: editingItem ? editingItem.id : Date.now().toString(),
      item_type: document.getElementById('item-type').value,
      name: document.getElementById('item-name').value,
      description: document.getElementById('item-description').value,
      start_datetime: document.getElementById('item-start-time').value,
      end_datetime: document.getElementById('item-end-time').value,
      cost: parseFloat(document.getElementById('item-cost').value) || 0,
      priority: parseInt(document.getElementById('item-priority').value),
      address: document.getElementById('item-address').value,
      details: {}
    };

    // 从地址解析坐标（简化处理）
    const addressParts = formData.address.split(',');
    if (addressParts.length === 2) {
      formData.latitude = parseFloat(addressParts[0]);
      formData.longitude = parseFloat(addressParts[1]);
    }

    // 根据类型收集详细信息
    switch (formData.item_type) {
      case 'accommodation':
        formData.details = {
          hotel_name: document.getElementById('hotel-name').value,
          room_type: document.getElementById('room-type').value,
          check_in_time: document.getElementById('check-in-time').value,
          check_out_time: document.getElementById('check-out-time').value,
          booking_platform: document.getElementById('booking-platform').value,
          booking_number: document.getElementById('booking-number').value
        };
        break;
      case 'transport':
        formData.details = {
          transport_type: document.getElementById('transport-type').value,
          carrier_name: document.getElementById('carrier-name').value,
          departure_location: document.getElementById('departure-location').value,
          arrival_location: document.getElementById('arrival-location').value
        };
        break;
      case 'attraction':
      case 'photo_spot':
        formData.details = {
          attraction_type: document.getElementById('attraction-type')?.value,
          ticket_price: parseFloat(document.getElementById('ticket-price')?.value),
          best_visit_time: document.getElementById('best-visit-time')?.value,
          recommended_duration: parseFloat(document.getElementById('recommended-duration')?.value),
          photography_tips: document.getElementById('photography-tips')?.value
        };
        break;
    }

    // 保存到列表
    if (editingItem) {
      const index = travelItems.findIndex(item => item.id === editingItem.id);
      travelItems[index] = formData;
    } else {
      travelItems.push(formData);
    }

    // 重新渲染
    renderMarkers();
    renderItemsList();
    renderTimeline();
    updateStatistics();

    // 关闭模态框
    closeModal('item-modal');

    // 显示成功提示
    showToast('保存成功', 'success');
  }

  // ==================== 工具函数 ====================

  // 格式化日期时间
  function formatDateTime(datetime) {
    const date = new Date(datetime);
    return date.toLocaleString('zh-CN', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // 格式化日期
  function formatDate(dateStr) {
    const date = new Date(dateStr);
    const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    return `${date.getMonth() + 1}月${date.getDate()}日 ${weekdays[date.getDay()]}`;
  }

  // 格式化时间
  function formatTime(datetime) {
    const date = new Date(datetime);
    return date.toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // 更新统计信息
  function updateStatistics() {
    const stats = {
      accommodation: 0,
      transport: 0,
      attraction: 0,
      budget: 0
    };

    travelItems.forEach(item => {
      if (item.item_type === 'accommodation') stats.accommodation++;
      if (item.item_type === 'transport') stats.transport++;
      if (item.item_type === 'attraction' || item.item_type === 'photo_spot') stats.attraction++;
      stats.budget += item.cost || 0;
    });

    document.getElementById('stat-accommodation').textContent = stats.accommodation;
    document.getElementById('stat-transport').textContent = stats.transport;
    document.getElementById('stat-attraction').textContent = stats.attraction;
    document.getElementById('stat-budget').textContent = stats.budget.toFixed(0);
  }

  // 显示提示信息
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOutDown 0.3s';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // 自动排布
  function autoArrangeItems() {
    // 按日期和优先级自动排布元素
    const itemsByDate = {};

    travelItems.forEach(item => {
      if (item.start_datetime) {
        const date = item.start_datetime.split('T')[0];
        if (!itemsByDate[date]) {
          itemsByDate[date] = [];
        }
        itemsByDate[date].push(item);
      }
    });

    // 按优先级和类型排序
    Object.values(itemsByDate).forEach(dayItems => {
      dayItems.sort((a, b) => {
        // 优先级高的排前面
        if (a.priority !== b.priority) {
          return b.priority - a.priority;
        }
        // 同优先级按类型排序（住宿一般在最后）
        const typeOrder = ['transport', 'attraction', 'photo_spot', 'rest_area', 'accommodation'];
        return typeOrder.indexOf(a.item_type) - typeOrder.indexOf(b.item_type);
      });
    });

    showToast('智能排布完成', 'success');
    renderTimeline();
  }

  // 初始化海拔图表
  function initElevationChart() {
    const canvas = document.getElementById('elevation-canvas');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    // 示例海拔数据
    const elevationData = [
      {distance: 0, elevation: 3000},
      {distance: 10, elevation: 3200},
      {distance: 20, elevation: 3500},
      {distance: 30, elevation: 3800},
      {distance: 40, elevation: 4200},
      {distance: 50, elevation: 4400},
      {distance: 60, elevation: 4300},
      {distance: 70, elevation: 4100},
      {distance: 80, elevation: 3900}
    ];

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: elevationData.map(d => `${d.distance}km`),
        datasets: [{
          label: '海拔（米）',
          data: elevationData.map(d => d.elevation),
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: '海拔（米）'
            }
          },
          x: {
            title: {
              display: true,
              text: '距离'
            }
          }
        }
      }
    });
  }

  // 文件上传处理
  document.addEventListener('DOMContentLoaded', () => {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    if (uploadArea && fileInput) {
      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragging');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragging');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragging');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });
    }
  });

  // 处理上传的文件
  function handleFiles(files) {
    const preview = document.getElementById('image-preview');

    Array.from(files).forEach(file => {
      if (!file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const item = document.createElement('div');
        item.className = 'image-preview-item';
        item.innerHTML = `
                <img src="${e.target.result}" alt="${file.name}">
                <button class="image-preview-remove" onclick="removeImage(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
        preview.appendChild(item);

        uploadedImages.push({
          name: file.name,
          url: e.target.result
        });
      };
      reader.readAsDataURL(file);
    });
  }

  // 移除图片
  function removeImage(button) {
    button.parentElement.remove();
  }

  // ==================== 页面加载 ====================

  window.addEventListener('load', () => {
    initMap();
  });

  // 阻止模态框点击事件冒泡
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal(modal.id);
      }
    });
  });

  document.querySelectorAll('.modal-content').forEach(content => {
    content.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  });
</script>
</body>
</html>